---
description: "Fact Verification Protocol - Ensure All Rules Are Based on Actual Codebase"
alwaysApply: true
globs:
  - "**/*"
---

# Fact Verification Protocol

## ğŸ¯ CRITICAL: Every Rule Must Be Verified

**Before creating or updating any PROJECT RULE, you MUST verify facts against the actual codebase.**

**Note:** This is a PROJECT-SPECIFIC rule. The universal principle "all decisions must be code-grounded" belongs in user rules, not here.

---

## âœ… Verification Checklist

### 1. File Existence Verification
**Before referencing any file:**
- âœ… Verify the file actually exists at the specified path
- âœ… Check the file extension matches (`.ts`, `.tsx`, `.py`, `.rs`)
- âœ… Verify directory structure matches (underscores vs hyphens)
- âœ… Confirm file is not in `.gitignore` or build artifacts

**How to Verify:**
```bash
# Check if file exists
ls -la path/to/file

# Verify directory structure
find . -name "chimera*" -type d
```

---

### 2. Code Pattern Verification
**Before documenting code patterns:**
- âœ… Read the actual file to see the implementation
- âœ… Verify function names, class names, and method signatures
- âœ… Check import statements and dependencies
- âœ… Confirm variable names and data structures

**How to Verify:**
```bash
# Read actual file
cat path/to/file

# Search for specific patterns
grep -r "pattern" path/to/directory
```

---

### 3. Integration Point Verification
**Before documenting service connections:**
- âœ… Find the actual code that performs the connection
- âœ… Verify the protocol (gRPC, Redis, HTTP, PostgreSQL)
- âœ… Check environment variables and configuration
- âœ… Confirm port numbers and addresses

**How to Verify:**
```bash
# Find integration code
grep -r "redis\|gRPC\|postgres\|DATABASE_URL" service/directory

# Check actual connection code
grep -r "connect\|lpush\|brpop" service/directory
```

---

### 4. Data Flow Verification
**Before documenting data flows:**
- âœ… Trace the actual code path from source to destination
- âœ… Verify each step in the flow exists
- âœ… Check file I/O operations (read/write)
- âœ… Confirm API endpoints and their implementations

**How to Verify:**
```bash
# Trace data flow
grep -r "function\|async\|await" path/to/component

# Check API routes
find app/api -name "route.ts" -exec grep -l "pattern" {} \;
```

---

### 5. Configuration Verification
**Before documenting configuration:**
- âœ… Read actual config files (`railway.toml`, `package.json`, `Cargo.toml`)
- âœ… Verify environment variable names
- âœ… Check port numbers and service names
- âœ… Confirm build commands and start commands

**How to Verify:**
```bash
# Read config files
cat service/railway.toml
cat service/package.json

# Check environment variables
grep -r "process.env\|os.getenv\|env::var" service/directory
```

---

## ğŸ” Fact-Checking Process

### Step 1: Identify the Claim
**Example:** "BrainScraper reads enriched leads from PostgreSQL"

### Step 2: Find the Actual Implementation
```bash
# Search for where enriched leads are loaded
grep -r "load.*enriched\|enriched.*load" brainscraper/app/enriched
grep -r "PostgreSQL\|pg\.\|Pool" brainscraper/app/enriched
```

### Step 3: Read the Actual Code
```typescript
// Read: brainscraper/app/enriched/page.tsx
// Find: fetch('/api/load-enriched-results')
// Read: brainscraper/app/api/load-enriched-results/route.ts
// Find: Reads from enriched-all-leads.json, NOT PostgreSQL
```

### Step 4: Verify Against Codebase
- âœ… **Claim:** "Reads from PostgreSQL"
- âœ… **Reality:** Reads from `/api/load-enriched-results` which reads from `enriched-all-leads.json`
- âœ… **Conclusion:** Claim is FALSE - must correct rule

### Step 5: Update Rule with Verified Facts
```markdown
**Viewer:** `brainscraper/app/enriched/page.tsx` 
- Calls: `/api/load-enriched-results`
- Reads from: `enriched-all-leads.json` (file system)
- Does NOT read from PostgreSQL
```

---

## ğŸš¨ Red Flags (Stop and Verify)

If you see any of these patterns, STOP and verify:

- âŒ "Service X communicates with Service Y" - Verify actual code
- âŒ "Data flows from A to B" - Trace actual code path
- âŒ "Uses protocol X" - Check actual implementation
- âŒ "Reads from database/queue/file" - Verify actual I/O operations
- âŒ "Port X is used for Y" - Check config files and code
- âŒ "File is located at path" - Verify file exists
- âŒ "Function does X" - Read actual function implementation

---

## ğŸ“‹ Verification Commands

### Verify File Exists
```bash
# Check file exists
test -f path/to/file && echo "EXISTS" || echo "NOT FOUND"

# List directory contents
ls -la path/to/directory
```

### Verify Code Pattern
```bash
# Search for pattern
grep -r "pattern" path/to/directory

# Count occurrences
grep -r "pattern" path/to/directory | wc -l
```

### Verify Integration
```bash
# Find connection code
grep -r "connect\|lpush\|brpop\|INSERT\|SELECT" service/directory

# Check imports
grep -r "import\|from\|use" service/directory | grep "redis\|grpc\|pg"
```

### Verify Configuration
```bash
# Read config files
cat service/railway.toml
cat service/package.json
cat service/Cargo.toml

# Check environment variables
grep -r "process.env\|os.getenv\|env::var" service/directory
```

---

## âœ… Verified Facts (Reference)

### Directory Names
- âœ… `chimera_brain` (underscore) - Verified: `ls -d chimera_brain`
- âœ… `chimera-core` (hyphen) - Verified: `ls -d chimera-core`
- âœ… `brainscraper` (no hyphen/underscore) - Verified: `ls -d brainscraper`
- âœ… `scrapegoat` (no hyphen/underscore) - Verified: `ls -d scrapegoat`

### Ports
- âœ… `brainscraper`: 3000 - Verified: `docker-compose.yml` and `railway.toml`
- âœ… `scrapegoat`: 8000 - Verified: `docker-compose.yml` and `railway.toml`
- âœ… `chimera_brain`: 8080 (HTTP), 50051 (gRPC) - Verified: `chimera_brain/railway.toml` and `server.py`

### Data Storage
- âœ… BrainScraper enriched leads: `enriched-all-leads.json` - Verified: `load-enriched-results/route.ts`
- âœ… Scrapegoat enriched leads: PostgreSQL `leads` table - Verified: `scrapegoat/app/enrichment/database.py`
- âœ… Redis queue: `leads_to_enrich` - Verified: `scrapegoat/main.py` and `start_redis_worker.py`

### Service Communication
- âœ… BrainScraper â†’ Scrapegoat: NOT via Redis (BrainScraper uses in-memory enrichment)
- âœ… Scrapegoat API â†’ Redis: `lpush("leads_to_enrich")` - Verified: `scrapegoat/main.py:110`
- âœ… Scrapegoat Worker â†’ Redis: `brpop("leads_to_enrich")` - Verified: `scrapegoat/start_redis_worker.py:163`
- âœ… Chimera Core â†’ Chimera Brain: gRPC on port 50051 - Verified: `chimera-core/src/client.rs` and `chimera_brain/server.py`

---

## ğŸ¯ Rule Update Protocol

**When updating a rule:**

1. âœ… **Identify the claim** to verify
2. âœ… **Search codebase** for actual implementation
3. âœ… **Read actual code** to confirm
4. âœ… **Verify against** multiple sources if possible
5. âœ… **Update rule** with verified facts only
6. âœ… **Remove assumptions** and unverified claims
7. âœ… **Document source** of verification (file paths, line numbers)

---

## ğŸ“ Example: Correcting a False Claim

### âŒ INCORRECT (Assumption):
```markdown
**Viewer:** `brainscraper/app/enriched/page.tsx` (reads from PostgreSQL)
```

### âœ… CORRECT (Verified):
```markdown
**Viewer:** `brainscraper/app/enriched/page.tsx`
- Calls: `/api/load-enriched-results` (line 147)
- Implementation: `brainscraper/app/api/load-enriched-results/route.ts`
- Reads from: `enriched-all-leads.json` (file system, line 37-38)
- Does NOT read from PostgreSQL
- Verified: 2026-01-17 by reading actual code
```

---

## ğŸš¨ Remember

**Every rule must be:**
- âœ… Based on actual code, not assumptions
- âœ… Verified against the codebase
- âœ… Documented with source references
- âœ… Updated when codebase changes
- âœ… Removed if no longer accurate

**Never:**
- âŒ Assume how something works
- âŒ Copy patterns from other projects
- âŒ Document "intended" behavior without verification
- âŒ Leave unverified claims in rules
